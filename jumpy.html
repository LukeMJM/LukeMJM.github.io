<html>
<head>
	<title>Jumpy</title>
    <script src="processing.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

</head>
<body style="padding: 2rem 0.25rem; background: #efefef;">
	<canvas id="canvas"></canvas>
    <script type="application/javascript">

    // Global variables which interact with parent page when using an IFrame
    var playerJSON;
    var scene = 0;    
    var buttonPressed = false;

    function findGetParameter(parameterName) {
        var result = null,
            temp = [];
        location.search
            .substr(1)
            .split("&")
            .forEach(function (item) {
            temp = item.split("=");
            if (temp[0] === parameterName) result = decodeURIComponent(temp[1]);
            });
        // uncomment line below to debug parameter setting
        // console.log(parameterName + ": " + result);
        return(result);
    }        

        // checking if player is me using a GET parameter
        var admin = findGetParameter("admin");

        // assigning values of GET parameters to variables for player object
        var h = findGetParameter("h");
        var w = findGetParameter("w");
        var s = findGetParameter("s");
        var g = findGetParameter("g");
        var iY = findGetParameter("iY");
        var l = findGetParameter("l");
        var id = findGetParameter("id");
        var unparsedCJE = findGetParameter("cJE");
        var cJE;

        if (unparsedCJE == "true") {
            cJE = true;
        } else if (unparsedCJE == "false") {
            cJE = false;
        } else {
            cJE = false;
        }

            // redirecting to allow easier editing of parameters if defaults are being used
    
        if (h == null) {
            // window.location = 'https://lukemjm.github.io/jumpy?h=40&w=10&s=5&g=0.5&iY=-12&l=5';

            
            // url using GET parameters for offline mode
            window.location = 'http://127.0.0.1:5500/jumpy.html?h=40&w=10&s=5&g=0.5&iY=-12&l=2&cJE=true';

        }


        function sketchProc(processing) {
       
            // *****************************************************
            //                  GLOBAL VARIABLES
            // *****************************************************
            var windowH, windowW;
            var centerY = 300, centerX = 200;
            var accFactor = 1.0
            var heightOfWindow = processing.height;
            var keyBeingPressed;
            // var scene = 0; moved to top
            var groundLevel = 300; 
            var randA = processing.random(0.5, 2);
            var randB = processing.random(0.5, 2);
            var debuggingOn = false;
            var jsonFlag = true;


            // *****************************************************
            //                     GAME OBJECTS
            // *****************************************************

            // *****************************************************
            //                  PLAYER CHARACTER
            // *****************************************************

            var Player = function() {

                // default settings to use if no GET parameters are used
                this.playerHeight = 40; //findGetParameter("h");
                this.width = 10; //findGetParameter("w");
                this.moveSpeed = 5; //findGetParameter("s");
                this.gravity = 0.5; //findGetParameter("g");
                this.impulseY = -12; //findGetParameter("iY");
                this.lives = 5; //findGetParameter("l");

                // changing input variables from strings to ints if they exist and overwriting defaults
                if (h != null){
                    this.height = parseInt(h);
                    this.width = parseInt(w);
                    this.moveSpeed = parseInt(s);
                    this.gravity = parseFloat(g);
                    this.impulseY = parseInt(iY);
                    this.lives = parseInt(l);
                    this.chamberedJumpEnabled = cJE;
                }

                // functional variables - not necessarily relevant in JSON
                this.score = 0;
                this.currentLives = this.lives;
                this.immunity = 0;
                this.velocityX; 
                this.velocityY;
                this.damgageTimer = 0;
                this.isColliding = false;
                this.damaged = false;
                this.positionX = centerX;
                this.positionY = centerY;
                this.movingLeft = false;
                this.movingRight = false;
                this.onGround = true;
                this.isJumping = false;
                this.chamberedJump = false;
                this.goingUp = true;

                // ID variable to be passed back into JSON
                this.id = id;

            };

            Player.prototype.draw = function() {
                
                if (this.damaged && ((this.damgageTimer >= 20 && this.damgageTimer <= 30) || (this.damgageTimer > 0 && this.damgageTimer < 11)) ) {
                    processing.fill(255, 100, 100);

                } else {
                    processing.fill(245, 245, 245);
                }
                processing.rect(this.positionX, this.positionY - this.height, this.width, this.height)

            };

            Player.prototype.jumpTwo = function() {
                
                this.velocityY = this.impulseY;
                this.onGround = false;
                    
            }

            Player.prototype.limitJump = function() {
                if (this.velocityY < -12) {
                    this.velocityY = -12;
                } 
            }

            Player.prototype.updatePosition = function() {
                
                if (jumpy.onGround == false) {
                    this.velocityY += this.gravity;
                    this.positionY += this.velocityY;

                    // stopping character from going under the ground level and ending the jump process
                    if (this.positionY >= groundLevel) {
                        this.positionY = groundLevel;
                        this.velocityY = 0;
                        this.onGround = true;
                        this.isJumping = false;

                        if (this.chamberedJump) {

                            check = true;
                            this.velocityY = this.impulseY;
                            this.onGround = false;
                            this.chamberedJump = false;
                            this.isJumping = true;
                        }
                    // stopping character from going outside game bounds - will abruptly stop and fall as would be expected
                    } else if (this.positionY <= this.height){
                        this.velocityY = 0;
                    }
                }
            }

            Player.prototype.checkCollision = function(obstacleArray) {

                if (this.immunity == 0) {
                    left = this.positionX;
                    right = this.positionX + this.width;
                    bottom = this.positionY;
                    top = this.positionY - this.height;

                    for (i =0; i < obstacleArray.length; i++) {
                        // checking if x coordintes are intersecting
                        if (right >= obstacleArray[i].x && left <= obstacleArray[i].x + obstacleArray[i].width) {
                        
                            if (bottom >= obstacleArray[i].y - obstacleArray[i].height) {
                                this.isColliding = true;
                                this.currentLives--;
                                this.damaged = true;
                                this.damgageTimer = 30;
                                this.immunity = 1;
                            }

                        } else {
                            this.isColliding = false;
                        }
                    }
                }
            };

            // Creating an instance of the player object

            var jumpy = new Player();

            // *****************************************************
            //                       OBSTACLES
            // *****************************************************


            var Obstacle = function(x, y, width, height, speed) {

                this.x = x;
                this.y = y;
                this.initialWidth = width;
                this.initialHeight = height;
                this.width = width;
                this.height = height;
                this.speed = speed;
            };

            Obstacle.prototype.draw = function() {
                processing.fill(220, 220, 220);
                processing.rect(this.x, this.y - this.height, this.width, this.height);
            };

            Obstacle.prototype.move = function() {
                this.x -= this.speed * accFactor;

                // reseting the obstacle if it clears the screen 
                // also adding to score as obstacle has been cleared by player
                if (this.x + this.width <= 0) {
                    this.x = 400;
                    this.speed += 0.25;
                    this.width = this.initialWidth * randA;
                    this.height = this.initialHeight * randB;
                    if (jumpy.immunity == 0) {
                        jumpy.score++;
                    } else if (jumpy.immunity == 1) {
                        jumpy.immunity = 0;
                    }
                }
            };

            // *******************************************************
            //                       SETUP
            // *******************************************************

            processing.setup = function(){
                processing.frameRate (60);
                processing.size(400,400);
                windowH = processing.height;
                windowW = processing.width;
                processing.background(200,200,200);
            }

            // Creating obstacles and putting into an array to keep them 
            
            var ob1 = new Obstacle(340, centerY, 20, 40, 2);
            var obstacleArray = [ob1];

            var heightestPoint = 200;

            // *******************************************************
            //                      GAME LOOP
            // *******************************************************
            processing.draw = function() {

                randA = processing.random(0.5, 1.5);
                randB = processing.random(0.5, 2);
                
                var centerX = windowW/2;
                var centerY = windowH/2;
                
                
                // getting the coordinates of the current mouse position
                var currentY = processing.mouseY;
                var currentX = processing.mouseX;           

                function drawGround(){
                    processing.rect(-1, groundLevel, windowW + 2, windowH);
                }

                function drawWall(height, width){ 
                    var xPosWall = 300;
                    processing.fill(245,245,245);
                    processing.rect(xPosWall, centerY-height, width, height);
                }

                // clear background
                processing.background(200,200,200);

                // *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*
                //                       START SCENE
                // *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*

                if (scene === 0) {
                    processing.fill(81, 166, 31);
                    // drawing start button
                    processing.rect(centerX - 40, centerY - 20, 80, 40);
                    processing.fill(255, 255, 255);
                    processing.textSize(18);
                    processing.text("START",centerX -28, centerY + 7);

                    // drawing controls text
                    processing.text("Controls",centerX -35, 50);
                    processing.textSize(16);
                    processing.text("Jump - click",centerX -45, 75);
                    processing.text("Move left - a",centerX -47, 90);
                    processing.text("Move right - d",centerX -50, 105);

                    processing.textSize(16);
                    processing.text("Jump over obstacles to increase your score",centerX -150, 145);

                    // checking if start button is clicked
                    processing.mouseClicked = function() {
                        if (scene === 0 && currentX >= 160 && currentX <= 240 &&
                            currentY >= 180 && currentY <= 220) {
                            
                            scene = 1;
                        }
                    };
                }

                // *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*
                //                      MAIN GAME SCENE
                // *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*

                // ****************************************************
                //              CHECKING FOR PLAYER INPUT
                // ****************************************************

                if (scene === 1) {
                    processing.mousePressed = function() {
                        if (scene === 1) {
                            jumpy.isJumping = true;
                            // allows player to chamber a jump if they are almost on the ground
                            // since impulse force is negative, we multiply by -1 to flip it to positve, then divide by 2 to give a number which represents
                            // the velocity the player will be at when moving downwards, but closer to the ground than the apex of the jump
                            if (jumpy.chamberedJumpEnabled && jumpy.isJumping && (jumpy.velocityY > 0 + ((jumpy.impulseY*-1)/2))) {
                                jumpy.chamberedJump = true;
                            }
                        }
                    }

                    processing.keyPressed = function() {
                        keyBeingPressed = processing.key;

                            // a = 97
                            if (keyBeingPressed == 97) {
                                jumpy.movingRight = false
                                jumpy.movingLeft = true;
                            // d = 100
                            } else if (keyBeingPressed == 100) {
                                jumpy.movingLeft = false
                                jumpy.movingRight = true;
                            } else if (keyBeingPressed == 32) {
                                jumpy.isJumping = true;
                                // allows player to chamber a jump if they are almost on the ground
                                // since impulse force is negative, we multiply by -1 to flip it to positve, then divide by 2 to give a number which represents
                                // the velocity the player will be at when moving downwards, but closer to the ground than the apex of the jump
                                if (jumpy.isJumping && (jumpy.velocityY > 0 + ((jumpy.impulseY*-1)/2))) {
                                    jumpy.chamberedJump = true;
                                }
                            }
                    }

                    processing.keyReleased = function() {
                        if (jumpy.movingLeft || jumpy.movingRight) {
                            jumpy.movingLeft = false;
                            jumpy.movingRight = false;
                        }
                    }

                    // ****************************************************
                    //                     MOVEMENT
                    // ****************************************************            

                    if (jumpy.movingLeft && jumpy.positionX > 0) {
                        jumpy.positionX -= jumpy.moveSpeed;

                    } else if (jumpy.movingRight && jumpy.positionX < 400 - jumpy.width ) {
                        jumpy.positionX += jumpy.moveSpeed;
                    }

                    // ****************************************************
                    //                     JUMPING
                    // **************************************************** 

                    if (jumpy.onGround && jumpy.isJumping){
                        jumpy.jumpTwo();
                    }

                    if (jumpy.isJumping) {
                        jumpy.updatePosition();
                        jumpy.limitJump();
                    }

                    
                    // ****************************************************
                    //                     DRAW GAME
                    // ****************************************************
                    
                    // Drawing the ground
                    processing.fill(245,245,245);
                    drawGround();

                    if (admin == "y") {

                        // drawing debugging button
                        processing.rect(40, 360, 55, 20);
                        processing.fill(10, 10, 10);
                        processing.textSize(10);
                        processing.text("Debugging", 43, 373);

                        // checking if debugging button is clicked
                        processing.mouseClicked = function() {
                            if (currentX >= 40 && currentX <= 95 &&
                                currentY >= 360 && currentY <= 380) {
                                
                                if (debuggingOn) {
                                    debuggingOn = false;
                                } else if (debuggingOn == false) {
                                    debuggingOn = true;
                                }
                            }
                        };

                    }


                    // Drawing obstacles
                    for (i =0; i < obstacleArray.length; i++) {
                        obstacleArray[i].draw();
                    }

                    for (i =0; i < obstacleArray.length; i++) {
                        obstacleArray[i].move();
                    }

                    // Drawing player
                    jumpy.draw();


                    // *******************************************************
                    //                   CHECK COLLISIONS
                    // *******************************************************

                    jumpy.checkCollision(obstacleArray);

                    
                    // *******************************************************
                    //                CHECK PLAYER's LIVES
                    // *******************************************************

                    if (jumpy.currentLives == 0) {
                        scene = 2;
                    }

                    if (jumpy.damaged && jumpy.damgageTimer > 0) {
                        jumpy.damgageTimer --
                    } else if (jumpy.damaged && jumpy.damgageTimer == 0) {
                        jumpy.damaged = false;
                    }

                    // ********************************************************
                    //               DISPLAY SCORE AND LIVES
                    //*********************************************************

                    processing.fill(245,245,245);
                    processing.text("Lives   " + jumpy.currentLives, 10,20);
                    processing.text("Score   " + jumpy.score, 330, 20);

                    // ********************************************************
                    //                      DEBUGGING
                    //*********************************************************

                    
                    if (debuggingOn) {
                        
                        if (jumpy.positionY < (200 - jumpy.jumpHeight)) {
                            jumpy.jumpHeight = (200 - jumpy.positionY);
                        }

                        processing.text("Player X   " +jumpy.positionX, 15,80);
                        processing.text("Player Y   " +jumpy.positionY, 15,90);
                        processing.fill(245,245,245);
                        processing.text("   ", 15,120);
                        processing.text("isJumping   " + jumpy.isJumping, 15,130);
                        processing.text("chambered jump   " + jumpy.chamberedJump, 15,140);
                        processing.text("Y Velocity   " + jumpy.velocityY, 15, 150);
                        processing.text("Gravity   " + jumpy.gravity, 15,160);
                        processing.text("Move Speed   " + (jumpy.moveSpeed), 15,170);
                        processing.text("colliding   " + jumpy.isColliding, 15,180);
                        processing.text("immunity   " + jumpy.immunity, 15,190);
                    }

                };

                // *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*
                //                         END SCENE
                // *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*

                if (scene === 2) {
                    processing.textSize(22);
                    processing.text(" Final Score:   " + jumpy.score, 110, centerY/2);
                    
                    if (jsonFlag) {

                        delete jumpy.immunity;
                        delete jumpy.velocityX;
                        delete jumpy.velocityY;
                        delete jumpy.damgageTimer;
                        delete jumpy.isColliding;
                        delete jumpy.damaged;
                        delete jumpy.positionX;
                        delete jumpy.positionY;
                        delete jumpy.movingLeft;
                        delete jumpy.movingRight;
                        delete jumpy.onGround;
                        delete jumpy.isJumping;
                        delete jumpy.chamberedJump;
                        delete jumpy.goingUp;
                        delete jumpy.currentLives;
                        delete jumpy.isJumping;

                        playerJSON = JSON.stringify(jumpy, null, 2);
                    
                        // uncomment line below to debug JSON output
                        // console.log(playerJSON);

                        jsonFlag = false;
                    }

                    

                    if (buttonPressed === false) {
                        processing.textSize(16);
                        processing.text("Please click the finish button below to", 60, centerY);
                        processing.text("confirm you have played this iteration.",60, centerY + 20);
                        document.getElementById("gameJSON").value = playerJSON;

                    } else {
                        processing.textSize(20);
                        processing.text("Thanks for playing!", 110, centerY - 20);
                        processing.textSize(16);
                        processing.text("If you haven't played all 3 iterations,", 70, centerY + 20);
                        processing.text("please continue with the next one.", 70, centerY + 40);
                    }

                    

                    hideAndUnhideFinishButton();

                }
            }
            
        } 

        var canvas = document.getElementById("canvas");
        // attaching the sketchProc function to the canvas
        var processingInstance = new Processing(canvas, sketchProc);

    </script>

    <div id="myDIV">
        <div class="container">
            <div class="row">
                <div class="col"></div>
                <div class="col">
                    <form name="user_data">
                        <div class="form-group">
                            <input type="hidden" name="gameJSON" class="form-control" id="gameJSON" aria-describedby="gameJSON" required>
                        </div>
                        <button onclick="buttonPressed = true;" class="btn btn-lg btn-success float-left" type="submit">Finish</button>
                    </form>
                </div>
                <div class="col"></div>
            </div>
        </div>
    </div>

    <script>
    
    // small function to hide the finish button on page load and show it once game is finished
    function hideAndUnhideFinishButton() {
        var x = document.getElementById("myDIV");
        if (scene === 2 && buttonPressed === false) {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }

    hideAndUnhideFinishButton();

    </script>

    <script type="text/javascript">

        // Using the form's submit button, let's submit the form using
        // JavaScript and jQuery.
        $("form[name='user_data']").submit(function(e) {
            // Prevent the form from submitting via its default manner.
            e.preventDefault();
            e.stopPropagation();

            // Send the user's age and height to the parent window--sending the
            // data as an object that the parent can receive and parse.
            console.log("Sending data to https://requester.mturk.com/create/projects/1621254.");
            parent.postMessage(
                {
                    gameJSON:    $("input[name='gameJSON']").val(),
                },
                "https://requester.mturk.com/create/projects/1621254");


        });

        

	</script>

</body>

</html>
